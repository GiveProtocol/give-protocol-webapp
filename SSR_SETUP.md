# Server-Side Rendering (SSR) Setup

This document explains the Vite SSR implementation for Give Protocol webapp.

## Overview

The application now supports Server-Side Rendering (SSR) to improve:
- **SEO**: Search engines can crawl fully-rendered HTML
- **Initial Load Performance**: Users see content before JavaScript loads
- **Accessibility**: Content available even with JavaScript disabled
- **Social Media Sharing**: Open Graph tags work correctly

## Architecture

### Entry Points

1. **`src/entry-client.tsx`** - Client-side hydration entry point
   - Uses `hydrateRoot()` to attach React to server-rendered HTML
   - Wraps app with `BrowserRouter` for client-side navigation

2. **`src/entry-server.tsx`** - Server-side rendering entry point
   - Uses `renderToString()` to generate HTML
   - Wraps app with `StaticRouter` for server rendering

3. **`server.js`** - Express server
   - Development: Uses Vite middleware for hot module replacement
   - Production: Serves pre-built static files

### Key Changes

- **`App.tsx`**: Removed `BrowserRouter` (now in entry files)
- **`index.html`**: Added `<!--app-html-->` placeholder for SSR injection
- **`vite.config.ts`**: Added SSR configuration with `noExternal` packages

## Development

### Start SSR Development Server
```bash
npm run dev
```
Runs Express server with Vite middleware on http://localhost:5173

### Start SPA Development Server (No SSR)
```bash
npm run dev:spa
```
Original Vite dev server for faster development when SSR isn't needed

## Building for Production

### Build Both Client and Server
```bash
npm run build
```
This runs:
1. `npm run build:client` - Builds client bundle to `dist/client/`
2. `npm run build:server` - Builds server bundle to `dist/server/`

### Preview Production Build
```bash
npm run preview
```
Runs production server with pre-built assets on http://localhost:5173

## Deployment

### Option 1: Node.js Server (Recommended)

Deploy the entire project with Node.js runtime:

```bash
# Build the app
npm run build

# Set environment variables
export NODE_ENV=production
export PORT=5173

# Start the server
node server.js
```

**Required Files for Deployment:**
- `server.js`
- `dist/` directory (generated by build)
- `package.json` and `package-lock.json`
- `.env` file (or environment variables)

### Option 2: Static Site Generation (SSG)

To pre-render specific routes as static HTML:

1. Create a prerender script (see `scripts/prerender.js` example below)
2. Run it after building:
```bash
npm run build
node scripts/prerender.js
```

### Environment Variables

SSR requires the same environment variables as the SPA:
- `VITE_SUPABASE_URL`
- `VITE_SUPABASE_ANON_KEY`
- `VITE_MOONBASE_RPC_URL`
- etc.

## Testing SSR

### Verify Server-Side Rendering Works

1. Start the dev or production server
2. Visit http://localhost:5173
3. View page source (right-click > View Page Source)
4. You should see fully-rendered HTML content inside `<div id="root">`

**Before SSR:** Empty `<div id="root"></div>`
**After SSR:** `<div id="root"><footer>...</footer><main>...</main></div>`

### Verify Hydration Works

1. Open DevTools Console
2. You should NOT see hydration errors
3. Interactive features should work immediately after page load

## Common Issues & Solutions

### Issue: "useNavigate() may be used only in the context of a <Router> component"

**Cause:** Router not properly configured in entry files
**Fix:** Ensure `BrowserRouter` in `entry-client.tsx` and `StaticRouter` in `entry-server.tsx`
**Status:** ✅ Fixed

### Issue: "localStorage is not defined"

**Cause:** Code trying to access localStorage during server render
**Fix:** Guard with SSR check:
```typescript
const [state, setState] = useState(() => {
  if (typeof window === 'undefined') return 'default';
  return localStorage.getItem('key') || 'default';
});

useEffect(() => {
  if (typeof window !== 'undefined') {
    localStorage.setItem('key', state);
  }
}, [state]);
```
**Status:** ✅ Fixed in `src/contexts/SettingsContext.tsx`

### Issue: "i18n.changeLanguage is not a function"

**Cause:** i18next not initialized properly for SSR, or language changes attempted during render
**Fix:**
1. Conditionally use `LanguageDetector` only on client
2. Move language changes to `useEffect`
```typescript
// In i18n config
const isServer = typeof window === 'undefined';
const i18nInstance = i18n.use(initReactI18next);
if (!isServer) {
  i18nInstance.use(LanguageDetector);
}

// In hooks
useEffect(() => {
  if (i18n.changeLanguage && i18n.language !== language) {
    i18n.changeLanguage(language);
  }
}, [i18n, language]);
```
**Status:** ✅ Fixed in `src/i18n/index.ts` and `src/hooks/useTranslation.ts`

### Issue: Styles not loading on first render

**Cause:** CSS not being extracted during SSR
**Fix:** Already configured in `vite.config.ts` with proper plugin order
**Status:** ✅ Working

### Issue: Context providers not working

**Cause:** Contexts that depend on browser APIs (localStorage, etc.)
**Fix:** Initialize with safe defaults on server, hydrate on client
**Status:** ✅ Fixed

## Performance Optimization

### Lazy Loading Routes

Already configured in `src/routes/index.tsx`:
```typescript
const Home = lazy(() => import("@/pages/Home"));
```

### Code Splitting

Vite automatically splits vendor code. See `vite.config.ts` `manualChunks` configuration.

### Caching Strategy

For production, consider:
- CDN for static assets (`dist/client/assets/*`)
- Edge caching for HTML pages
- Service Worker for offline support

## Migration Notes

### What Changed

1. **Entry points split**: `main.tsx` → `entry-client.tsx` + `entry-server.tsx`
2. **Router moved**: `BrowserRouter` moved from `App.tsx` to entry files
3. **New dependencies**: express, compression, sirv, cross-env
4. **New scripts**: `dev`, `build:client`, `build:server`, `preview`

### What Stayed the Same

- All components work identically
- All routes remain unchanged
- No changes to component code required
- Development workflow similar (just use `npm run dev`)

## Future Enhancements

Consider implementing:

1. **Streaming SSR**: Use `renderToPipeableStream()` for faster TTFB
2. **Static Site Generation**: Pre-render marketing pages at build time
3. **Edge Rendering**: Deploy to Cloudflare Workers or Vercel Edge
4. **Partial Hydration**: Use React Server Components when stable

## Support

For issues or questions about SSR setup:
- Check Vite SSR docs: https://vitejs.dev/guide/ssr.html
- Check React docs: https://react.dev/reference/react-dom/server
- Open an issue in the repository

---

**Last Updated:** January 2025
**Vite Version:** 7.1.11
**React Version:** 18.2.0
